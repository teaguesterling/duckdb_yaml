# name: test/sql/yaml_reader/yaml_type_conflicts.test
# description: Test handling of type conflicts during jagged schema detection
# group: [yaml_reader]
#
# Related issues:
# - #17: STRUCT to VARCHAR fallback causes data loss (FIXED)
# - #18: YAMLNodeToValue fails silently for STRUCT when target type is VARCHAR (FIXED)
# - #19: LIST to VARCHAR fallback causes data loss (FIXED)

require yaml

# Test 1: Reading file with struct metadata alone
query III
SELECT name, metadata.author, metadata.version FROM read_yaml('test/yaml/type_conflicts/struct_value.yaml');
----
file1	John	1.0

# Test 2: Reading file with scalar metadata alone
query II
SELECT name, metadata FROM read_yaml('test/yaml/type_conflicts/scalar_value.yaml');
----
file2	simple string value

# Test 3: Reading files with different struct fields - should merge fields
query IIII
SELECT name, metadata.author, metadata.version, metadata.extra_field
FROM read_yaml(['test/yaml/type_conflicts/struct_value.yaml', 'test/yaml/type_conflicts/struct_different.yaml'])
ORDER BY name;
----
file1	John	1.0	NULL
file3	Jane	NULL	bonus

# Test 4: STRUCT vs scalar conflict - falls back to YAML type preserving data
# When there's a type conflict (STRUCT vs scalar), the schema falls back to YAML type
# which serializes the values as YAML strings, preserving all data
query II
SELECT name, metadata IS NULL as metadata_is_null
FROM read_yaml('test/yaml/type_conflicts/*.yaml')
ORDER BY name;
----
file1	false
file2	false
file3	false

# Test 5: LIST vs scalar conflict - falls back to YAML type preserving data
# When there's a type conflict (LIST vs scalar), the schema falls back to YAML type
# which serializes the values as YAML strings, preserving all data
query II
SELECT name, tags IS NULL as tags_is_null
FROM read_yaml('test/yaml/type_conflicts/*.yaml')
ORDER BY name;
----
file1	false
file2	false
file3	false

# Test 6: Verify the actual YAML serialization of conflicting types
query III
SELECT name, metadata, tags
FROM read_yaml('test/yaml/type_conflicts/*.yaml')
ORDER BY name;
----
file1	{author: John, version: 1.0}	[alpha, beta]
file2	simple string value	single-tag
file3	{author: Jane, created: 2024-01-15, extra_field: bonus}	[gamma]
