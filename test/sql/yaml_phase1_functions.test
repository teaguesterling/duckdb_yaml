# name: test/sql/yaml_phase1_functions.test
# description: Test Phase 1 Core Functions (JSON parity functions)
# group: [yaml]

require yaml

#===--------------------------------------------------------------------===#
# yaml_array_length tests
#===--------------------------------------------------------------------===#

# Test basic array length
query I
SELECT yaml_array_length('[1, 2, 3, 4, 5]'::YAML);
----
5

# Test empty array
query I
SELECT yaml_array_length('[]'::YAML);
----
0

# Test array length with path
query I
SELECT yaml_array_length('{items: [a, b, c, d]}'::YAML, '$.items');
----
4

# Test array length on non-array returns NULL
query I
SELECT yaml_array_length('{name: John}'::YAML);
----
NULL

# Test array length with invalid path returns NULL
query I
SELECT yaml_array_length('[1, 2, 3]'::YAML, '$.missing');
----
NULL

# Test nested array length
query I
SELECT yaml_array_length('{data: {values: [1, 2, 3, 4, 5, 6]}}'::YAML, '$.data.values');
----
6

#===--------------------------------------------------------------------===#
# yaml_keys tests
#===--------------------------------------------------------------------===#

# Test basic object keys
query I
SELECT yaml_keys('{name: John, age: 30, city: NYC}'::YAML);
----
[name, age, city]

# Test empty object
query I
SELECT yaml_keys('{}'::YAML);
----
[]

# Test keys with path
query I
SELECT yaml_keys('{person: {name: John, age: 30}}'::YAML, '$.person');
----
[name, age]

# Test keys on non-object returns NULL
query I
SELECT yaml_keys('[1, 2, 3]'::YAML);
----
NULL

# Test keys with invalid path returns NULL
query I
SELECT yaml_keys('{name: John}'::YAML, '$.missing');
----
NULL

# Test nested keys
query I
SELECT yaml_keys('{data: {user: {id: 1, email: test@example.com}}}'::YAML, '$.data.user');
----
[id, email]

#===--------------------------------------------------------------------===#
# yaml_array_elements tests
#===--------------------------------------------------------------------===#

# Test basic array unnesting
query I
SELECT * FROM yaml_array_elements('[1, 2, 3]'::YAML);
----
1
2
3

# Test array with objects
query I
SELECT * FROM yaml_array_elements('[{name: Alice}, {name: Bob}, {name: Charlie}]'::YAML);
----
{name: Alice}
{name: Bob}
{name: Charlie}

# Test array with mixed types
query I
SELECT * FROM yaml_array_elements('[1, hello, true, {key: value}]'::YAML);
----
1
hello
true
{key: value}

# Test empty array
query I
SELECT * FROM yaml_array_elements('[]'::YAML);
----

# Test array with nested arrays
query I
SELECT * FROM yaml_array_elements('[[1, 2], [3, 4], [5, 6]]'::YAML);
----
[1, 2]
[3, 4]
[5, 6]

#===--------------------------------------------------------------------===#
# yaml_each tests
#===--------------------------------------------------------------------===#

# Test basic object unnesting
query II
SELECT * FROM yaml_each('{name: John, age: 30, active: true}'::YAML) ORDER BY key;
----
active	true
age	30
name	John

# Test empty object
query II
SELECT * FROM yaml_each('{}'::YAML);
----

# Test object with nested values
query II
SELECT * FROM yaml_each('{id: 1, data: {nested: value}, tags: [a, b]}'::YAML) ORDER BY key;
----
data	{nested: value}
id	1
tags	[a, b]

# Test object with null values
query II
SELECT key, value FROM yaml_each('{a: 1, b: ~, c: 3}'::YAML) ORDER BY key;
----
a	1
b	~
c	3

#===--------------------------------------------------------------------===#
# yaml_build_object tests
#===--------------------------------------------------------------------===#

# Test basic object building
query I
SELECT yaml_build_object('name', 'John', 'age', 30);
----
{name: John, age: 30}

# Test empty object
query I
SELECT yaml_build_object();
----
{}

# Test object with various types
query I
SELECT yaml_build_object('str', 'hello', 'num', 42, 'bool', true);
----
{str: hello, num: 42, bool: true}

# Test object with YAML values
query I
SELECT yaml_build_object('data', '[1, 2, 3]'::YAML, 'nested', '{key: value}'::YAML);
----
{data: [1, 2, 3], nested: {key: value}}

#===--------------------------------------------------------------------===#
# yaml_agg tests
#===--------------------------------------------------------------------===#

# Test basic aggregation
statement ok
CREATE TABLE test_agg AS SELECT * FROM (VALUES (1), (2), (3), (4), (5)) t(x);

query I
SELECT yaml_agg(x) FROM test_agg;
----
[1, 2, 3, 4, 5]

# Test aggregation with strings
statement ok
CREATE TABLE test_agg_str AS SELECT * FROM (VALUES ('apple'), ('banana'), ('cherry')) t(fruit);

query I
SELECT yaml_agg(fruit) FROM test_agg_str;
----
[apple, banana, cherry]

# Test aggregation with YAML values
statement ok
CREATE TABLE test_agg_yaml AS SELECT * FROM (VALUES ('{name: Alice}'::YAML), ('{name: Bob}'::YAML), ('{name: Charlie}'::YAML)) t(person);

query I
SELECT yaml_agg(person) FROM test_agg_yaml;
----
[{name: Alice}, {name: Bob}, {name: Charlie}]

# Test aggregation with GROUP BY
statement ok
CREATE TABLE test_agg_group AS SELECT * FROM (VALUES (1, 'a'), (1, 'b'), (2, 'c'), (2, 'd')) t(grp, val);

query II
SELECT grp, yaml_agg(val) FROM test_agg_group GROUP BY grp ORDER BY grp;
----
1	[a, b]
2	[c, d]

# Test aggregation with empty result
statement ok
CREATE TABLE test_agg_empty AS SELECT * FROM (VALUES (1)) t(x) WHERE FALSE;

query I
SELECT yaml_agg(x) FROM test_agg_empty;
----
[]

# Test aggregation ignores NULLs
statement ok
CREATE TABLE test_agg_null AS SELECT * FROM (VALUES (1), (NULL), (2), (NULL), (3)) t(x);

query I
SELECT yaml_agg(x) FROM test_agg_null;
----
[1, 2, 3]

#===--------------------------------------------------------------------===#
# Combined usage tests
#===--------------------------------------------------------------------===#

# Build object and get keys
query I
SELECT yaml_keys(yaml_build_object('a', 1, 'b', 2, 'c', 3));
----
[a, b, c]

# Unnest array and aggregate back
query I
SELECT yaml_agg(value) FROM yaml_array_elements('[1, 2, 3, 4, 5]'::YAML);
----
[1, 2, 3, 4, 5]

# Unnest object and build it back
query I
SELECT yaml_build_object(key, value) as rebuilt
FROM yaml_each('{name: Alice, age: 30}'::YAML)
ORDER BY key;
----
{age: 30}
{name: Alice}

# Get array length from aggregated values
statement ok
CREATE TABLE test_combined AS SELECT * FROM (VALUES (1), (2), (3)) t(x);

query I
SELECT yaml_array_length(yaml_agg(x)) FROM test_combined;
----
3

# Test with read_yaml integration
statement ok
CREATE OR REPLACE TABLE test_yaml_file AS SELECT * FROM (VALUES
    ('{items: [apple, banana, cherry]}'),
    ('{items: [dog, cat]}'),
    ('{items: [red, green, blue, yellow]}')
) t(yaml_data);

query I
SELECT yaml_array_length(CAST(yaml_data AS YAML), '$.items') as item_count FROM test_yaml_file ORDER BY item_count;
----
2
3
4
