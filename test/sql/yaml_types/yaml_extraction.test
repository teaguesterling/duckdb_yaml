# name: test/sql/yaml_types/yaml_extraction.test
# description: Test YAML extraction functions
# group: [yaml_types]

require yaml

statement ok
CREATE TABLE test_yaml AS SELECT 
  '{"name": "John", "age": 30, "address": {"city": "NYC", "zip": 10001}}' as yaml_simple,
  '[1, 2, [3, 4]]' as yaml_array,
  'null' as yaml_null
;

# Test yaml_type function - unary version
query I
SELECT yaml_type(yaml_simple::YAML) FROM test_yaml;
----
object

query I
SELECT yaml_type(yaml_array::YAML) FROM test_yaml;
----
array

query I
SELECT yaml_type(yaml_null::YAML) FROM test_yaml;
----
null

# Test yaml_type function - binary version (with path)
query I
SELECT yaml_type(yaml_simple::YAML, '$.name') FROM test_yaml;
----
scalar

query I
SELECT yaml_type(yaml_simple::YAML, '$.address') FROM test_yaml;
----
object

query I
SELECT yaml_type(yaml_simple::YAML, '$.address.city') FROM test_yaml;
----
scalar

query I
SELECT yaml_type(yaml_array::YAML, '$[2]') FROM test_yaml;
----
array

# Test yaml_extract function
query I
SELECT yaml_extract(yaml_simple::YAML, '$.name') FROM test_yaml;
----
John

query I
SELECT yaml_extract(yaml_simple::YAML, '$.age') FROM test_yaml;
----
30

query I
SELECT yaml_extract(yaml_simple::YAML, '$.address.city') FROM test_yaml;
----
NYC

query I
SELECT yaml_extract(yaml_array::YAML, '$[0]') FROM test_yaml;
----
1

query I
SELECT yaml_extract(yaml_array::YAML, '$[2]') FROM test_yaml;
----
[3, 4]

# Test yaml_extract_string function
query I
SELECT yaml_extract_string(yaml_simple::YAML, '$.name') FROM test_yaml;
----
John

query I
SELECT yaml_extract_string(yaml_simple::YAML, '$.address') FROM test_yaml;
----
{city: NYC, zip: 10001}

query I
SELECT yaml_extract_string(yaml_simple::YAML, '$.missing') FROM test_yaml;
----
NULL

# Test yaml_exists function
query I
SELECT yaml_exists(yaml_simple::YAML, '$.name') FROM test_yaml;
----
true

query I
SELECT yaml_exists(yaml_simple::YAML, '$.missing') FROM test_yaml;
----
false

query I
SELECT yaml_exists(yaml_simple::YAML, '$.address.city') FROM test_yaml;
----
true

query I
SELECT yaml_exists(yaml_array::YAML, '$[5]') FROM test_yaml;
----
false

# Test with actual YAML type values
statement ok
CREATE TABLE yaml_typed (data YAML);

statement ok
INSERT INTO yaml_typed VALUES 
  (value_to_yaml({'name': 'Alice', 'scores': [90, 85, 92]})),
  (value_to_yaml(['apple', 'banana', 'cherry']));

query I
SELECT yaml_type(data) FROM yaml_typed;
----
object
array

query I
SELECT yaml_extract_string(data, '$.name') FROM yaml_typed WHERE yaml_exists(data, '$.name');
----
Alice

query I
SELECT yaml_extract(data, '$.scores[1]') FROM yaml_typed WHERE yaml_exists(data, '$.scores');
----
85

query I
SELECT yaml_extract(data, '$[1]') FROM yaml_typed WHERE yaml_type(data) = 'array';
----
banana

# ===== Arrow Operator (->> for extract_string) =====
# Note: The -> operator cannot be used for YAML because DuckDB's planner
# hardcodes it to json_extract. Use yaml_extract() function instead.
# The ->> operator works because it's a regular function alias.

# Test ->> operator (equivalent to yaml_extract_string, returns VARCHAR)

query I
SELECT yaml_simple::YAML->>'$.name' FROM test_yaml;
----
John

query I
SELECT yaml_simple::YAML->>'$.age' FROM test_yaml;
----
30

query I
SELECT yaml_simple::YAML->>'$.address.city' FROM test_yaml;
----
NYC

query I
SELECT yaml_simple::YAML->>'$.missing' FROM test_yaml;
----
NULL

# Test ->> with VARCHAR input (no YAML cast needed)

query I
SELECT yaml_simple->>'$.name' FROM test_yaml;
----
John

query I
SELECT yaml_simple->>'$.address.city' FROM test_yaml;
----
NYC

# Test ->> chained with yaml_extract for complex paths

query I
SELECT yaml_extract(yaml_simple::YAML, '$.address')->>'$.city' FROM test_yaml;
----
NYC

# Test ->> with YAML typed columns

query I
SELECT data->>'$.name' FROM yaml_typed WHERE yaml_exists(data, '$.name');
----
Alice

query I
SELECT data->>'$.scores[0]' FROM yaml_typed WHERE yaml_exists(data, '$.scores');
----
90

query I
SELECT data->>'$[0]' FROM yaml_typed WHERE yaml_type(data) = 'array';
----
apple

# ===== YAML Structure Function =====
# Returns JSON representation of the YAML schema/structure

# Simple object
query I
SELECT yaml_structure('name: Alice
age: 30');
----
{"name":"VARCHAR","age":"UBIGINT"}

# Nested object
query I
SELECT yaml_structure('user:
  name: Bob
  active: true');
----
{"user":{"name":"VARCHAR","active":"BOOLEAN"}}

# Simple array
query I
SELECT yaml_structure('[1, 2, 3]');
----
["UBIGINT"]

# Array of objects - keys should be merged (order may vary due to unordered_map)
# Check that both 'a' and 'b' keys are present in the structure
query I
SELECT yaml_structure('[{a: 1}, {b: 2}]')::VARCHAR LIKE '%"a"%'
   AND yaml_structure('[{a: 1}, {b: 2}]')::VARCHAR LIKE '%"b"%';
----
true

# Nested array
query I
SELECT yaml_structure('scores: [90, 85, 92]');
----
{"scores":["UBIGINT"]}

# Mixed types - strings
query I
SELECT yaml_structure('items:
  - hello
  - world');
----
{"items":["VARCHAR"]}

# Boolean values
query I
SELECT yaml_structure('enabled: true
disabled: false');
----
{"enabled":"BOOLEAN","disabled":"BOOLEAN"}

# Null value
query I
SELECT yaml_structure('value: null');
----
{"value":"NULL"}

# Empty array
query I
SELECT yaml_structure('items: []');
----
{"items":["NULL"]}

# Double/float values
query I
SELECT yaml_structure('pi: 3.14159
rate: 0.5');
----
{"pi":"DOUBLE","rate":"DOUBLE"}

# Negative integers
query I
SELECT yaml_structure('temp: -10
offset: -100');
----
{"temp":"BIGINT","offset":"BIGINT"}

# Works with YAML type input
query I
SELECT yaml_structure(yaml_simple::YAML) FROM test_yaml;
----
{"name":"VARCHAR","age":"UBIGINT","address":{"city":"VARCHAR","zip":"UBIGINT"}}

# ===== YAML Contains Function =====
# Check if first YAML document contains second

# Object contains partial object
query I
SELECT yaml_contains('a: 1
b: 2', 'a: 1');
----
true

# Object doesn't contain (wrong value)
query I
SELECT yaml_contains('a: 1
b: 2', 'a: 2');
----
false

# Object doesn't contain (missing key)
query I
SELECT yaml_contains('a: 1', 'b: 1');
----
false

# Array contains element
query I
SELECT yaml_contains('[1, 2, 3]', '2');
----
true

# Array doesn't contain element
query I
SELECT yaml_contains('[1, 2, 3]', '4');
----
false

# Nested object containment
query I
SELECT yaml_contains('user:
  name: Alice
  age: 30', 'user:
  name: Alice');
----
true

# Scalar equality
query I
SELECT yaml_contains('hello', 'hello');
----
true

# Scalar inequality
query I
SELECT yaml_contains('hello', 'world');
----
false

# Null containment
query I
SELECT yaml_contains('value: null', 'value: null');
----
true

# Array contains array (subset)
query I
SELECT yaml_contains('[1, 2, 3, 4]', '[2, 3]');
----
true

# Array doesn't contain array (not subset)
query I
SELECT yaml_contains('[1, 2, 3]', '[2, 5]');
----
false

# Empty object is contained in any object
query I
SELECT yaml_contains('a: 1', '{}');
----
true

# Works with YAML type input
query I
SELECT yaml_contains(yaml_simple::YAML, 'name: John') FROM test_yaml;
----
true

query I
SELECT yaml_contains(yaml_simple::YAML, 'name: Jane') FROM test_yaml;
----
false

# ===== YAML Merge Patch Function (RFC 7386) =====
# Merge two YAML documents

# Basic merge - patch values override target
query I
SELECT yaml_merge_patch('a: 1
b: 2', 'b: 3
c: 4');
----
{a: 1, b: 3, c: 4}

# Null removes key
query I
SELECT yaml_merge_patch('a: 1
b: 2', 'b: null');
----
{a: 1}

# Nested merge - recursively merges objects
query I
SELECT yaml_merge_patch('a:
  x: 1
  y: 2', 'a:
  y: 3');
----
{a: {x: 1, y: 3}}

# Array replacement - arrays are replaced, not merged
query I
SELECT yaml_merge_patch('a: [1, 2]', 'a: [3, 4, 5]');
----
{a: [3, 4, 5]}

# Scalar replacement
query I
SELECT yaml_merge_patch('hello', 'world');
----
world

# Non-object target with object patch
query I
SELECT yaml_merge_patch('hello', 'a: 1');
----
{a: 1}

# Empty patch leaves target unchanged
query I
SELECT yaml_merge_patch('a: 1
b: 2', '{}');
----
{a: 1, b: 2}

# Multiple nested levels
query I
SELECT yaml_merge_patch('a:
  b:
    c: 1
    d: 2', 'a:
  b:
    d: 3
    e: 4');
----
{a: {b: {c: 1, d: 3, e: 4}}}

# Works with YAML type input
query I
SELECT yaml_merge_patch(yaml_simple::YAML, 'name: Jane') FROM test_yaml;
----
{name: Jane, age: 30, address: {city: NYC, zip: 10001}}